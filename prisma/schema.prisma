// schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ScrapingProvider {
  EPROCURE
  ETENDER
  EPROCURE_CPPP
  CUSTOM
}

enum SessionStatus {
  RUNNING
  COMPLETED
  FAILED
  STOPPED
  PAUSED
}

model ScrapingSession {
  id                      String           @id
  
  // Basic session info
  name                    String?
  description             String?
  provider                ScrapingProvider
  baseUrl                 String
  status                  SessionStatus
  
  // Progress tracking
  progress                Float            @default(0)
  
  // Statistics
  organizationsFound      Int              @default(0)
  organizationsScraped    Int              @default(0)
  tendersFound            Int              @default(0)
  tenderScraped           Int              @default(0)
  tendersSaved            Int              @default(0)
  pagesNavigated          Int              @default(0)
  pagesPerMinute          Float            @default(0)
  avgResponseTime         Float            @default(0)
  
  // Current activity tracking
  currentOrganization     String?
  currentStage            String?
  
  // Timestamps
  startedAt               DateTime
  completedAt             DateTime?
  lastActivityAt          DateTime
  
  // Error information (for failed sessions)
  errorMessage            String?
  
  // Estimated time fields
  estimatedCompletionTime DateTime?
  estimatedTimeRemaining  Int?             // in milliseconds
  estimatedTimeRemainingFormatted String?
  scrapingRate           Float?           // tenders per minute
  timePerTender          Int?             // milliseconds per tender
  
  // Metadata
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt
  
  // Relations
  tenders                 Tender[]
  
  @@index([provider])
  @@index([status])
  @@index([startedAt])
  @@index([lastActivityAt])
}

model Tender {
  id                      String           @id @default(uuid())
  
  // Tender identification
  tenderId                String
  tenderRefNo             String
  version                 Int              @default(1)
  isLatest                Boolean          @default(true)
  
  // Tender details
  tenderValue             Float?
  workDescription         String
  tenderType              String?
  contractDate            String?
  completionInfo          String?
  preBidMeetingDate       String?
  preBidMeetingAddress    String?
  preBidMeetingPlace      String?
  periodOfWork            String?
  organisationChain       String
  organisation            String
  tenderInvitingAuthorityName     String?
  tenderInvitingAuthorityAddress  String?
  
  // EMD details
  emdAmount               Float?
  emdFeeType              String?
  emdExceptionAllowed     Boolean          @default(false)
  emdPercentage           Float?
  emdPayableTo            String?
  emdPayableAt            String?
  principal               String?
  
  // Location details
  location                String?
  pincode                 String?
  
  // Dates (stored as strings in exact format from website)
  publishedDate           String
  bidOpeningDate          String?
  bidSubmissionStartDate  String?
  bidSubmissionEndDate    String?
  
  // Other details
  isSuretyBondAllowed     Boolean          @default(false)
  sourceOfTender          String?
  compressedTenderDocumentsURI String?
  // CPP-specific post-award fields
  selectedBidders         String[]        @default([])
  numberOfBidsReceived    Int?
  numberOfBidderSelected  Int?
  selectedBiddersAddress  String?
  selectedBiddersCsv      String?
  
  // Scraping metadata
  provider                ScrapingProvider
  sourceUrl               String
  scrapedAt               DateTime
  dataHash                String
  sessionId               String?
  
  // Relations
  session                 ScrapingSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  
  // Timestamps
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt
  
  @@unique([tenderId, tenderRefNo, version])
  @@index([tenderId])
  @@index([tenderRefNo])
  @@index([tenderId, tenderRefNo, isLatest])
  @@index([isLatest])
  @@index([provider])
  @@index([sessionId])
  @@index([scrapedAt])
  @@index([createdAt])
}